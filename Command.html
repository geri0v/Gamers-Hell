<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upcoming GW2 Events (45 min)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .event-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .event-item input {
      flex: 1;
      padding: 6px;
      font-size: 14px;
      margin-right: 6px;
    }
    .copy-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: url('https://i.postimg.cc/Pf2Qp0Xq/World-Completion.png')
                  no-repeat center/cover;
      cursor: pointer;
    }
    .copy-btn:hover {
      background: url('https://i.postimg.cc/qMNzGyvH/pve-e6fdf7c3.png')
                  no-repeat center/cover;
    }
  </style>
</head>
<body>

  <h1>Events in the Next 45 Minutes</h1>
  <div id="mainContent">Loading…</div>

  <script>
  // fetch helper
  async function fetchJson(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(r.statusText);
    return r.json();
  }

  // get upcoming events within `windowMin`
  async function getUpcoming(windowMin = 45) {
    const now = Date.now();
    const cutoff = now + windowMin * 60_000;
    const events = await fetchJson('https://api.guildwars2.com/v2/events?ids=all');
    return events
      .filter(e => e.next_time && e.location?.center)
      .map(e => ({
        name:     e.name,
        map_id:   e.map_id,
        nextTime: new Date(e.next_time).getTime(),
        coord:    e.location.center
      }))
      .filter(e => e.nextTime > now && e.nextTime <= cutoff);
  }

  // render into #mainContent
  async function renderList() {
    const container = document.getElementById('mainContent');
    container.innerHTML = '';

    let upcoming;
    try {
      upcoming = await getUpcoming(45);
    } catch (err) {
      return container.textContent = 'Error: ' + err.message;
    }

    if (upcoming.length === 0) {
      return container.textContent = 'No events in the next 45 minutes.';
    }

    // fetch map names
    const mapIds = Array.from(new Set(upcoming.map(e => e.map_id))).join(',');
    const maps   = await fetchJson(`https://api.guildwars2.com/v2/maps?ids=${mapIds}`);
    const mapNames = Object.fromEntries(maps.map(m => [m.id, m.name]));

    // build list
    upcoming.forEach((e, i) => {
      const minsLeft = Math.ceil((e.nextTime - Date.now()) / 60_000);
      const [x, y]   = e.coord.map(c => c.toFixed(0));
      const label    = `${e.name} on ${mapNames[e.map_id]} ‒ ${minsLeft} min @${x},${y}`;

      const row = document.createElement('div');
      row.className = 'event-item';

      const inp = document.createElement('input');
      inp.type    = 'text';
      inp.value   = `${mapNames[e.map_id]} – ${x},${y}`;
      inp.id      = `evt_${i}`;
      inp.disabled= true;

      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.title     = 'Copy location';
      btn.onclick   = () => {
        inp.disabled = false;
        inp.select();
        document.execCommand('copy');
        inp.disabled = true;
        alert(`Copied: ${inp.value}`);
      };

      row.append(inp, btn);
      container.append(row);
    });
  }

  // init + auto-refresh
  document.addEventListener('DOMContentLoaded', () => {
    renderList();
    setInterval(renderList, 5 * 60_000);
  });
  </script>

</body>
</html>
