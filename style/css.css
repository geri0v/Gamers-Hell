// visual.js — Final Full Version (Steps 0–8)

import { loadAndEnrichData } from './infoload.js';
import {
  renderSearchBar,
  renderFilterBar,
  renderSortButtons,
  filterEvents
} from './search.js';
import { renderEventGroups } from './card.js';
import { groupByExpansionAndSource } from './event.js';
import { paginate } from './pagination.js';
import {
  startTerminal,
  appendTerminal,
  endTerminal
} from './terminal.js';
import {
  saveEventCache,
  loadEventCache,
  getCacheInfo,
  clearEventCache
} from './cache.js';

// === State ===
let allEvents = [];
let currentFilters = {
  searchTerm: '',
  expansion: '',
  rarity: '',
  lootType: '',
  itemType: '',
  eventName: ''
};
let currentSort = '';
let currentPage = 1;
const pageSize = 20;

// === Helpers ===
function getUnique(list) {
  return [...new Set(list.filter(Boolean))].sort().map(v => ({ val: v, text: v }));
}

function applySort(events, key) {
  return events.slice().sort((a, b) => {
    switch (key) {
      case 'name': return (a.name || '').localeCompare(b.name || '');
      case 'map': return (a.map || '').localeCompare(b.map || '');
      case 'value': {
        const aVal = Math.max(...(a.loot || []).map(i => i.price || 0));
        const bVal = Math.max(...(b.loot || []).map(i => i.price || 0));
        return bVal - aVal;
      }
      default: return 0;
    }
  });
}

function setupInfiniteScroll() {
  const sentinel = document.getElementById('infinite-scroll-sentinel');
  if (!sentinel) return;

  if (window.infiniteScrollObserver) {
    window.infiniteScrollObserver.disconnect();
  }

  window.infiniteScrollObserver = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) {
      const filtered = filterEvents(allEvents, currentFilters);
      const sorted = currentSort ? applySort(filtered, currentSort) : filtered;
      const paginated = paginate(sorted, pageSize, currentPage);
      if (paginated.length < sorted.length) {
        currentPage++;
        updateUI();
      }
    }
  }, { root: null, threshold: 1.0 });

  window.infiniteScrollObserver.observe(sentinel);
}

// === Cache Status UI Bar ===
function renderCacheInfoBar() {
  const info = getCacheInfo();
  const bar = document.createElement('div');
  bar.className = 'cache-info-bar';
  bar.textContent = info
    ? `🧠 Cache: ${new Date(info.timestamp).toLocaleString()} • Events: ${info.size} • Expired: ${info.expired ? 'Yes' : 'No'}`
    : '🧠 No cache loaded.';

  const clearBtn = document.createElement('button');
  clearBtn.textContent = 'Clear Cache';
  clearBtn.onclick = () => {
    clearEventCache();
    appendTerminal('🧹 Cache cleared.', 'info');
    updateUI();
  };

  bar.appendChild(clearBtn);
  return bar;
}

// === Main Renderer ===
function updateUI() {
  const filtered = filterEvents(allEvents, currentFilters);
  const sorted = currentSort ? applySort(filtered, currentSort) : filtered;
  const paginated = paginate(sorted, pageSize, currentPage);
  const grouped = groupByExpansionAndSource(paginated);

  const app = document.getElementById('app');
  app.innerHTML = '';

  const topUI = document.createElement('div');
  topUI.className = 'top-ui-bar';

  topUI.appendChild(renderSearchBar(term => {
    currentFilters.searchTerm = term;
    updateUI();
  }));

  topUI.appendChild(renderFilterBar({
    expansions: getUnique(allEvents.map(e => e.expansion)),
    events: getUnique(allEvents.map(e => e.name)),
    rarities: getUnique(allEvents.flatMap(e => (e.loot || []).map(l => l.rarity))),
    current: currentFilters
  }, (key, val) => {
    currentFilters[key] = val;
    updateUI();
  }));

  topUI.appendChild(renderSortButtons(key => {
    currentSort = key;
    updateUI();
  }));

  topUI.appendChild(renderCacheInfoBar());

  app.appendChild(topUI);
  app.appendChild(renderEventGroups(grouped));

  // Scroll sentinel for infinite loading
  if (!document.getElementById('infinite-scroll-sentinel')) {
    const sentinel = document.createElement('div');
    sentinel.id = 'infinite-scroll-sentinel';
    sentinel.style.height = '1px';
    app.appendChild(sentinel);
    setupInfiniteScroll();
  }
}

// === Boot Sequence ===
async function boot() {
  startTerminal();
  let events = loadEventCache();

  if (events) {
    appendTerminal(`⚡ Loaded ${events.length} events from cache.`, 'success');
  } else {
    appendTerminal('🌐 Fetching event data from source...', 'progress');
    events = await loadAndEnrichData(ev => {
      appendTerminal(`➕ ${ev.name} loaded [${ev.map}]`, 'info');
    });

    saveEventCache(events);
    appendTerminal('📦 Saved to cache.', 'success');
  }

  allEvents = events;
  currentPage = 1;
  updateUI();

  appendTerminal(`✅ App is ready. Displaying ${events.length} events.`, 'success');
  endTerminal(true);
}

window.addEventListener('DOMContentLoaded', boot);
