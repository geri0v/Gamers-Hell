<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gamers-Hell Command</title>
  <style>
    /* ====== GRID LAYOUT ====== */
    html, body { margin:0; padding:0; height:100vh; }
    body {
      display:grid;
      grid-template-columns:360px 1fr 360px;
      grid-template-areas:"navleft main navright";
      font-family:Arial,sans-serif;
      background:#3c6e8d65;
    }
    .sidenav{grid-area:navleft;}
    .sidenav2{grid-area:navright;}
    .main{grid-area:main;overflow-y:auto;padding:20px;box-sizing:border-box;}

    /* ====== SIDEBARS ====== */
    .sidenav, .sidenav2 {
      background:#111;color:#818181;overflow-y:auto;height:100%;
    }
    .sidenav a, .sidenav2 a {
      display:block;padding:8px 16px;font-size:16px;
      text-decoration:none;color:inherit;
    }
    .sidenav a:hover, .sidenav2 a:hover { color:#f1f1f1; }

    /* ====== COLLAPSIBLE NAV ====== */
    .sidenav details{padding:4px 16px;color:#818181;cursor:pointer;}
    .sidenav summary{
      list-style:none;font-size:16px;user-select:none;
    }
    .sidenav summary::-webkit-details-marker{display:none;}
    .sidenav summary::before{
      content:"▸";display:inline-block;width:1em;transition:transform .2s;
    }
    .sidenav details[open] summary::before{content:"▾";}
    .sidenav details a{padding-left:32px;font-size:15px;}

    /* ====== MAIN CONTENT ====== */
    .center{text-align:center;margin-bottom:1em;}
    h1,h2{margin:.5em 0;}
    h2{
      border-bottom:1px solid #ccc;
      padding-bottom:.2em;
      margin-top:1.5em;
    }

    /* ====== TELEPORTER ROWS ====== */
    .textbox-container{
      display:flex;align-items:center;margin:6px 0;
    }
    .textbox{
      flex:1;padding:6px;font-size:14px;
      border:1px solid #ccc;border-radius:4px;background:#fff;
    }
    .copy-button{
      width:24px;height:24px;margin-left:6px;
      border:none;cursor:pointer;border-radius:4px;
      background:url('https://i.postimg.cc/Pf2Qp0Xq/World-Completion.png')
        no-repeat center/cover;
    }
    .copy-button:hover{
      background-image:url('https://i.postimg.cc/qMNzGyvH/pve-e6fdf7c3.png');
    }

    /* ====== DROPS LIST ====== */
    .drops-container{
      margin-left:32px;margin-top:8px;
    }
    .item-drop{
      display:flex;align-items:center;gap:8px;
      margin:4px 0;font-size:14px;
    }
    .item-drop img{
      width:24px;height:24px;
    }
    .item-drop small{
      color:#555;margin-left:4px;
    }

    /* ====== SUMMARY ====== */
    .summary-container {
      margin:8px 0;
      display:flex;align-items:flex-start;gap:6px;
    }
    .summary-container textarea {
      flex:1;
      font-size:13px;
      padding:6px;
      border-radius:4px;
      border:1px solid #ccc;
      resize:vertical;
    }

    footer{
      text-align:center;padding:1em 0;background:#ececec;
      margin-top:2em;font-size:.9em;
    }
    textarea[disabled] { background:#f5f5f5; }
  </style>
</head>
<body>
  <!-- LEFT NAV -->
  <nav class="sidenav" id="sideNav"></nav>

  <!-- MAIN CONTENT -->
  <div class="main">

    <!-- Welcome & Password Prompt -->
    <section id="Welcome" class="center">
      <h1>Welcome Commander</h1>
      <script>
        (function(){
          const PASS = "PvE";
          if (prompt('Password?','') !== PASS) {
            location.href = 'https://sites.google.com/view/gamers-hell-community';
          } else alert('Welcome Commander');
        })();
      </script>
    </section>

    <!-- Dynamic Boss Content -->
    <div id="mainContent"></div>

    <!-- Credits -->
    <section id="Credits" class="center">
      <h2>Credits</h2>
      <textarea rows="6" disabled>
Gamers-Hell Community
Players Vs Events:
  Blaz, Devilish Rain, Stormmyknight, Beina, Geri V

Websites:
  https://wiki.guildwars2.com/wiki
  https://gw2efficiency.com/
  http://gw2timer.com/
      </textarea>
    </section>

    <footer>&copy; 2025 Gamers-Hell Community</footer>
  </div>

  <!-- RIGHT TIMER -->
  <nav class="sidenav2">
    <iframe
      src="http://gw2timer.com/?page=Timetable&enu_Language=en&int_setClock=2&bol_use24Hour=true"
      width="100%" height="100%" frameborder="0"
      style="box-shadow:0 0 12px #223;">
    </iframe>
  </nav>
<script>
  /*————————————————————
    1) YOUR BOSS/EVENT LIST
    name:      display name
    code:      in-game share code
    location:  where it spawns
  ————————————————————*/
  const data = {
    "Core Tyria": {
      "World Bosses": [
        {
          name:     "Taidha Covington",
          code:     "[&BKgBAAA=]",
          location: "Iron Marches"
        },
        {
          name:     "Karka Queen",
          code:     "[&BNcGAAA=]",
          location: "Caledon Forest"
        },
        {
          name:     "Jungle Wurm",
          code:     "[&BEEFAAA=]",
          location: "Straits of Devastation"
        }
      ],
      "Ley-Line Anomaly": [
        {
          name:     "Legendary Anomaly A",
          code:     "[&BEwCAAA=]",
          location: "Stormbluff Isle"
        },
        {
          name:     "Legendary Anomaly B",
          code:     "[&BOcBAAA=]",
          location: "Timberline Falls"
        }
      ]
    },
    // … add your other categories here …
  };

  /*————————————————————
    2) UTILITIES: copy, gold-format, sidebar
  ————————————————————*/
  function copyToClipboard(id) {
    const ta = document.getElementById(id);
    ta.disabled = false;
    ta.select();
    document.execCommand('copy');
    ta.disabled = true;
    alert(`Copied to clipboard`);
  }

  function toGold(copper) {
    const g = Math.floor(copper/10000),
          s = Math.floor((copper%10000)/100),
          c = copper%100;
    return `${g}g ${s}s ${c}c`;
  }

  function buildNav(parent,obj) {
    Object.entries(obj).forEach(([k,v])=>{
      if (Array.isArray(v)) {
        const a = document.createElement('a');
        a.href = `#${k.replace(/\s+/g,'')}`;
        a.textContent = k;
        parent.appendChild(a);
      } else {
        const d = document.createElement('details');
        const s = document.createElement('summary');
        s.textContent = k;
        d.appendChild(s);
        buildNav(d,v);
        parent.appendChild(d);
      }
    });
  }

  function generateNav() {
    const nav = document.getElementById('sideNav');
    nav.innerHTML = '';
    // static Welcome
    const w = document.createElement('a');
    w.href='#Welcome'; w.textContent='Welcome';
    nav.appendChild(w);
    // dynamic
    buildNav(nav,data);
    // static Credits
    const c = document.createElement('a');
    c.href='#Credits'; c.textContent='Credits';
    nav.appendChild(c);
  }

  /*————————————————————
    3) WIKI LOOT FETCH
  ————————————————————*/
  function toWikiTitle(name) {
    return name
      .replace(/[’‘']/g,'')
      .replace(/[^a-zA-Z0-9 ]/g,'')
      .trim()
      .replace(/\s+/g,'_');
  }

  async function getLootSectionIndex(title) {
    const u = new URL('https://wiki.guildwars2.com/api.php');
    u.search = new URLSearchParams({
      action: 'parse',
      page: title,
      prop: 'sections',
      format:'json',
      origin:'*'
    });
    const j = await fetch(u).then(r=>r.json());
    return j.parse?.sections.find(s=>s.line==='Loot')?.index || null;
  }

  async function fetchLootIDs(title, idx) {
    const u = new URL('https://wiki.guildwars2.com/api.php');
    u.search = new URLSearchParams({
      action:'parse',
      page:title,
      prop:'text',
      section:idx,
      format:'json',
      origin:'*'
    });
    const j = await fetch(u).then(r=>r.json());
    const html = j.parse?.text['*'] || '';
    const doc = new DOMParser().parseFromString(html,'text/html');
    return Array.from(
      doc.querySelectorAll('span.item[data-item-id]')
    ).map(el=> Number(el.dataset.itemId));
  }

  async function fetchBossDrops(name) {
    const title = toWikiTitle(name);
    const idx   = await getLootSectionIndex(title);
    if (!idx) return [];
    return await fetchLootIDs(title, idx);
  }

  /*————————————————————
    4) PRICE FETCH + FALLBACK
  ————————————————————*/
  async function fetchPricesOfficial(ids) {
    const res = await fetch(
      `https://api.guildwars2.com/v2/commerce/prices?ids=${ids.join(',')}`
    );
    if (!res.ok) throw new Error('official TP failed');
    return await res.json();
  }

  async function fetchPricesGWE(id) {
    // GW2Eff API, single‐ID fallback
    const res = await fetch(
      `https://api.gw2efficiency.com/web/data/prices?id=${id}`
    );
    if (!res.ok) throw new Error('GWE fallback failed');
    const j = await res.json();
    return { id, buy:j.highest_buy_unit_price, sell:j.lowest_sell_unit_price };
  }

  async function resolvePrices(ids) {
    let prices = {};
    try {
      const off = await fetchPricesOfficial(ids);
      off.forEach(p=> prices[p.id]=p);
    } catch(err) {
      console.warn(err);
    }
    // handle any missing
    for (let id of ids) {
      if (!prices[id]) {
        try {
          const fb = await fetchPricesGWE(id);
          prices[id] = fb;
        } catch(e) {
          prices[id] = { id, buy:0, sell:0 };
        }
      }
    }
    return prices;
  }

  /*————————————————————
    5) BUILD & RENDER
  ————————————————————*/
  function buildContent(parent, obj, itemMap, priceMap) {
    Object.entries(obj).forEach(([sec,arr])=>{
      if (!Array.isArray(arr)) return buildContent(parent,arr,itemMap,priceMap);

      const S = document.createElement('section');
      S.id = sec.replace(/\s+/g,'');
      S.innerHTML = `<h2>${sec}</h2>`;

      arr.forEach((boss,i)=>{
        // 5a) teleport share‐code row
        const tc = document.createElement('div');
        tc.className='textbox-container';
        const ti = document.createElement('input');
        ti.type='text'; ti.className='textbox';
        ti.value=`${boss.name}: ${boss.code}`;
        ti.id=`tp_${sec}_${i}`; ti.disabled=true;
        const tb = document.createElement('button');
        tb.className='copy-button'; tb.title='Copy Teleport Code';
        tb.onclick=()=>copyToClipboard(ti.id);
        tc.append(ti,tb);
        S.appendChild(tc);

        // 5b) drops listing
        if (Array.isArray(boss.drops)) {
          const D = document.createElement('div');
          D.className='drops-container';
          boss.drops.forEach(id=>{
            const info = itemMap[id]||{};
            const price=priceMap[id]||{};
            const d = document.createElement('div');
            d.className='item-drop';
            d.innerHTML=`
              <img src="${info.icon||''}" alt="${info.name||id}">
              <span>${info.name||'Unknown'}</span>
              <small>Buy: ${toGold(price.highest_buy_unit_price||price.buy||0)}</small>
              <small>Sell: ${toGold(price.lowest_sell_unit_price||price.sell||0)}</small>
              <small>${info.binding==='Account'?'Account Bound':''}</small>
            `;
            D.appendChild(d);
          });
          S.appendChild(D);
        }

        // 5c) summary textarea + copy
        const sumDIV = document.createElement('div');
        sumDIV.className='summary-container';
        const ta = document.createElement('textarea');
        ta.rows= (boss.drops?.length||1)*1 + 4;
        ta.id = `sum_${sec}_${i}`;
        let txt = `Boss: ${boss.name}\n`;
        txt    += `Location: ${boss.location}\n`;
        txt    += `Teleport: ${boss.code}\n`;
        if (boss.drops?.length) {
          txt += `Drops:\n`;
          boss.drops.forEach(id=>{
            const info = itemMap[id]||{};
            const price=priceMap[id]||{};
            const buy  = toGold(price.highest_buy_unit_price||price.buy||0);
            const sell = toGold(price.lowest_sell_unit_price||price.sell||0);
            const ab   = info.binding==='Account'? ' (AB)' : '';
            txt += ` - ${info.name||id}: Buy ${buy}, Sell ${sell}${ab}\n`;
          });
        }
        ta.value = txt;
        ta.disabled=true;
        const cb = document.createElement('button');
        cb.className='copy-button';
        cb.title='Copy Summary';
        cb.style.backgroundImage="url('https://i.postimg.cc/qMNzGyvH/pve-e6fdf7c3.png')";
        cb.onclick = ()=>copyToClipboard(ta.id);
        sumDIV.append(ta, cb);
        S.appendChild(sumDIV);
      });

      parent.appendChild(S);
    });
  }

  /*————————————————————
    6) INITIALIZE ON LOAD
  ————————————————————*/
  document.addEventListener('DOMContentLoaded', async()=>{
    generateNav();

    // 6a) fetch drops for each boss
    const bosses = [];
    (function c(o){
      Object.values(o).forEach(v=>{
        if (Array.isArray(v)) v.forEach(b=>bosses.push(b));
        else c(v);
      });
    })(data);

    await Promise.all(
      bosses.map(b=> fetchBossDrops(b.name).then(ids=> b.drops=ids))
    );

    // 6b) batch fetch item info
    const allIds = [...new Set(bosses.flatMap(b=>b.drops))];
    const items  = await fetch(`https://api.guildwars2.com/v2/items?ids=${allIds.join(',')}`)
                        .then(r=>r.json());
    const itemMap= {};
    items.forEach(i=> itemMap[i.id]=i);

    // 6c) fetch prices with fallback
    const priceMap = await resolvePrices(allIds);

    // 6d) render
    const mc = document.getElementById('mainContent');
    mc.innerHTML = '';
    buildContent(mc, data, itemMap, priceMap);
  });
</script>
</body>
</html>
